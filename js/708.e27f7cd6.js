(self["webpackChunksl_device_vue"]=self["webpackChunksl_device_vue"]||[]).push([[708],{2708:function(t,e,i){"use strict";i.r(e),i.d(e,{default:function(){return p}});var n=function(){var t=this,e=t._self._c;return e("div",{staticClass:"app-container"},[e("van-field",{attrs:{readonly:"",label:"起点"},model:{value:t.info.name,callback:function(e){t.$set(t.info,"name",e)},expression:"info.name"}}),e("van-field",{attrs:{required:"",label:"托运人姓名",placeholder:"请输入"},model:{value:t.temp.user_name,callback:function(e){t.$set(t.temp,"user_name",e)},expression:"temp.user_name"}}),e("van-field",{attrs:{required:"",label:"托运人电话",placeholder:"请输入",type:"tel"},model:{value:t.temp.user_phone,callback:function(e){t.$set(t.temp,"user_phone",e)},expression:"temp.user_phone"}}),e("van-field",{attrs:{"is-link":"",readonly:"",required:"",label:"终点",placeholder:"请选择"},on:{click:function(e){t.showEnd=!0}},model:{value:t.endField,callback:function(e){t.endField=e},expression:"endField"}}),e("van-popup",{attrs:{round:"",position:"bottom"},model:{value:t.showEnd,callback:function(e){t.showEnd=e},expression:"showEnd"}},[e("van-cascader",{attrs:{required:"",title:"请选择",options:t.options},on:{close:function(e){t.showEnd=!1},finish:t.onEndFinish},model:{value:t.temp.to_area_id,callback:function(e){t.$set(t.temp,"to_area_id",e)},expression:"temp.to_area_id"}})],1),e("van-field",{attrs:{"is-link":"",readonly:"",required:"",label:"服务点",placeholder:"请选择"},on:{click:function(e){t.showPicker=!0}},model:{value:t.service_point_name,callback:function(e){t.service_point_name=e},expression:"service_point_name"}}),e("van-popup",{attrs:{round:"",position:"bottom"},model:{value:t.showPicker,callback:function(e){t.showPicker=e},expression:"showPicker"}},[e("van-picker",{attrs:{"show-toolbar":"",columns:t.servicePointList},on:{cancel:function(e){t.showPicker=!1},confirm:t.onSelect}})],1),e("van-field",{attrs:{rows:"3",autosize:"",label:"备注",type:"textarea",maxlength:"200",placeholder:"请详细描述运送任务，以便我们更高效提供服务，如病人床位，运送时间、是否需要工具等","show-word-limit":""},model:{value:t.temp.note,callback:function(e){t.$set(t.temp,"note",e)},expression:"temp.note"}}),e("van-cell",{attrs:{title:"图片",value:""}}),e("div",{staticStyle:{width:"100%"}},[e("van-uploader",{staticStyle:{float:"left"},attrs:{multiple:"","max-count":5,"after-read":t.afterRead,"max-size":5242880},on:{oversize:t.onOversize},model:{value:t.fileList,callback:function(e){t.fileList=e},expression:"fileList"}})],1),e("van-cell",{attrs:{title:"语音",value:""}}),e("van-cell",{staticStyle:{color:"red"},attrs:{title:"*请点击开始录入语音，录入完毕后再点击停止录音"}}),e("div",{staticStyle:{width:"100%","text-align":"center"}},[e("van-button",{attrs:{round:"",type:"primary",size:"small"},on:{click:t.startRecordAudio}},[t._v("开始录音")]),e("span",{staticStyle:{display:"inline-block",width:"70px","margin-top":"5px","font-size":"12px"}},[t._v("时长:"+t._s(t.recorder.duration.toFixed(1)))]),e("van-button",{attrs:{round:"",type:"primary",size:"small"},on:{click:t.stopRecordAudio}},[t._v("停止录音")]),e("van-button",{attrs:{round:"",type:"primary",size:"small"},on:{click:function(e){return t.playRecordAudio()}}},[t._v("播放录音")])],1),e("div",{staticStyle:{margin:"10px 30px"}},[e("van-button",{attrs:{round:"",block:"",type:"info",icon:"checked"},on:{click:t.onSubmit}},[t._v("保存")])],1)],1)},o=[],r=(i(4114),i(5055)),s=i.n(r),a={name:"AddTransport",data(){return{info:{},temp:{to_area_id:null,sp_id:null,note:"",file_list:[]},showEnd:!1,endField:"",options:[],showPicker:!1,servicePointList:[],service_point_name:"",fileList:[],beginRecoding:!1,recorder:new(s())({sampleBits:16,sampleRate:16e3,numChannels:1}),nowDuration:"",audioUrl:""}},async mounted(){this.temp.project_code=this.$route.query.code,this.temp.type=this.$route.query.type,this.temp.id=this.$route.query.id,this.info=await this.$http.post("/visitor/get-qrcode-info",{project_code:this.temp.project_code,type:this.temp.type,id:this.temp.id}),this.info.full_name&&(this.info.name=this.info.full_name),this.temp.from_area_id=this.info.id,this.temp.from_area_name=this.info.name,await this.getAreaList(),await this.getServicePointList()},beforeDestroy(){this.destroyRecorder()},methods:{async getAreaList(){this.options=await this.$http.post("/visitor/building-areas/tree-list",{project_code:this.temp.project_code})},async getServicePointList(){this.servicePointList=await this.$http.post("/visitor/service-point/choose-list",{project_code:this.temp.project_code,service_type:"transport",type:""})},onEndFinish({selectedOptions:t}){this.showEnd=!1,this.endField=t.map((t=>t.text)).join("/")},onSelect(t){this.temp.sp_id=t.value,this.service_point_name=t.text,console.log(t,this.temp.service_point_id),this.showPicker=!1},afterRead(t){},onOversize(t){this.$toast("文件大小不能超过 5 * 1024kb")},startRecordAudio(){s().getPermission().then((()=>{console.log("开始录音"),this.recorder.start()}),(t=>{this.$toast("请先允许该网页使用麦克风"),console.log(`${t.name} : ${t.message}`)}))},stopRecordAudio(){console.log("停止录音"),this.recorder.stop()},playRecordAudio(){console.log("播放录音"),this.recorder.play()},destroyRecorder(){this.recorder&&(this.recorder.destroy(),this.recorder=null)},async uploadWAVData(){var t=this.recorder.getWAVBlob();if(null==t||this.recorder.duration.toFixed(1)<1)return null;console.log("开始上传");var e=new FormData;const i=new Blob([t],{type:"audio/wav"}),n=new File([i],(new Date).getTime()+".wav");e.append("file",n);const o=await this.$postFile("/visitor/audio/upload",e,{headers:{"Content-Type":"multipart/form-data"}});return o},async onSubmit(){if(!this.temp.user_name)return void this.$toast("姓名不能为空");if(!this.temp.user_phone)return void this.$toast("手机号不能为空");if(!this.temp.to_area_id)return void this.$toast("终点不能为空");if(!this.temp.sp_id)return void this.$toast("服务点不能为空");let t=!0;var e=this.recorder.getWAVBlob();if((null==e||this.recorder.duration.toFixed(1)<1)&&(t=!1),!this.temp.note&&!t)return void this.$toast("请填写备注或者录入语言");const i=[];this.fileList&&this.fileList.length>0&&this.fileList.map((t=>{t&&t.content&&i.push(t.content.substring(t.content.indexOf(",")+1))}));const n=await this.$dialog.confirm({title:"标题",message:"是否确认保存？"}).catch((()=>{}));if(!n)return;const o=await this.uploadWAVData();this.temp.file_list=i,this.temp.audioUrl=o,await this.$http.post("/visitor/transport-ticket/save",this.temp),this.temp.to_area_id="",this.temp.sp_id="",this.temp.user_name="",this.temp.user_phone="",this.temp.note="",this.fileList=[],this.nowDuration="",this.audioUrl="",this.$dialog.alert({message:"保存成功！"}).then((()=>{this.$router.back()}))}}},l=a,u=i(845),c=(0,u.A)(l,n,o,!1,null,"43fbeb88",null),p=c.exports},1684:function(t,e,i){i(4114),i(6573),i(8100),i(7936),i(7467),i(4732),i(9577),i(4603),i(7566),i(8721),function(e,i){t.exports=i()}(0,(function(){return function(t){var e={};function i(n){if(e[n])return e[n].exports;var o=e[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,i),o.l=!0,o.exports}return i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)i.d(n,o,function(e){return t[e]}.bind(null,o));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=1)}([function(t,e,i){"use strict";function n(t,e,i){for(var n=0;n<i.length;n++)t.setUint8(e+n,i.charCodeAt(n))}Object.defineProperty(e,"__esModule",{value:!0}),e.compress=function(t,e,i){for(var n=e/i,o=Math.max(n,1),r=t.left,s=t.right,a=Math.floor((r.length+s.length)/n),l=new Float32Array(a),u=0,c=0;u<a;){var p=Math.floor(c);l[u]=r[p],u++,s.length&&(l[u]=s[p],u++),c+=o}return l},e.encodePCM=function(t,e,i){void 0===i&&(i=!0);var n=0,o=t.length*(e/8),r=new ArrayBuffer(o),s=new DataView(r);if(8===e)for(var a=0;a<t.length;a++,n++){var l=(u=Math.max(-1,Math.min(1,t[a])))<0?128*u:127*u;l=+l+128,s.setInt8(n,l)}else for(a=0;a<t.length;a++,n+=2){var u=Math.max(-1,Math.min(1,t[a]));s.setInt16(n,u<0?32768*u:32767*u,i)}return s},e.encodeWAV=function(t,e,i,o,r,s){void 0===s&&(s=!0);var a=i>e?e:i,l=r,u=new ArrayBuffer(44+t.byteLength),c=new DataView(u),p=o,d=0;n(c,d,"RIFF"),d+=4,c.setUint32(d,36+t.byteLength,s),n(c,d+=4,"WAVE"),n(c,d+=4,"fmt "),d+=4,c.setUint32(d,16,s),d+=4,c.setUint16(d,1,s),d+=2,c.setUint16(d,p,s),d+=2,c.setUint32(d,a,s),d+=4,c.setUint32(d,p*a*(l/8),s),d+=4,c.setUint16(d,p*(l/8),s),d+=2,c.setUint16(d,l,s),n(c,d+=2,"data"),d+=4,c.setUint32(d,t.byteLength,s),d+=4;for(var h=0;h<t.byteLength;)c.setUint8(d,t.getUint8(h)),d++,h++;return c}},function(t,e,i){"use strict";var n,o=this&&this.__extends||(n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(e,"__esModule",{value:!0});var r=i(2),s=i(0),a=i(3),l=function(t){function e(e){void 0===e&&(e={});var i=t.call(this,e)||this;return i.isrecording=!1,i.ispause=!1,i.isplaying=!1,i}return o(e,t),e.prototype.setOption=function(t){void 0===t&&(t={}),this.setNewOption(t)},e.prototype.start=function(){return this.isrecording?Promise.reject():(this.isrecording=!0,this.startRecord())},e.prototype.pause=function(){this.isrecording&&!this.ispause&&(this.ispause=!0,this.pauseRecord())},e.prototype.resume=function(){this.isrecording&&this.ispause&&(this.ispause=!1,this.resumeRecord())},e.prototype.stop=function(){this.isrecording&&(this.isrecording=!1,this.ispause=!1,this.stopRecord())},e.prototype.play=function(){this.stop(),this.isplaying=!0,this.onplay&&this.onplay(),a.default.addPlayEnd(this.onplayend);var t=this.getWAV();t.byteLength>44&&a.default.play(t.buffer)},e.prototype.getPlayTime=function(){return a.default.getPlayTime()},e.prototype.pausePlay=function(){!this.isrecording&&this.isplaying&&(this.isplaying=!1,this.onpauseplay&&this.onpauseplay(),a.default.pausePlay())},e.prototype.resumePlay=function(){this.isrecording||this.isplaying||(this.isplaying=!0,this.onresumeplay&&this.onresumeplay(),a.default.resumePlay())},e.prototype.stopPlay=function(){this.isrecording||(this.isplaying=!1,this.onstopplay&&this.onstopplay(),a.default.stopPlay())},e.prototype.destroy=function(){return a.default.destroyPlay(),this.destroyRecord()},e.prototype.getRecordAnalyseData=function(){return this.getAnalyseData()},e.prototype.getPlayAnalyseData=function(){return a.default.getAnalyseData()},e.prototype.getPCM=function(){this.stop();var t=this.getData();return t=s.compress(t,this.inputSampleRate,this.outputSampleRate),s.encodePCM(t,this.oututSampleBits,this.littleEdian)},e.prototype.getPCMBlob=function(){return new Blob([this.getPCM()])},e.prototype.downloadPCM=function(t){void 0===t&&(t="recorder");var e=this.getPCMBlob();r.downloadPCM(e,t)},e.prototype.getWAV=function(){var t=this.getPCM();return s.encodeWAV(t,this.inputSampleRate,this.outputSampleRate,this.config.numChannels,this.oututSampleBits,this.littleEdian)},e.prototype.getWAVBlob=function(){return new Blob([this.getWAV()],{type:"audio/wav"})},e.prototype.downloadWAV=function(t){void 0===t&&(t="recorder");var e=this.getWAVBlob();r.downloadWAV(e,t)},e.prototype.download=function(t,e,i){r.download(t,e,i)},e.prototype.getChannelData=function(){var t=this.getPCM(),e=t.byteLength,i=this.littleEdian,n={left:null,right:null};if(2===this.config.numChannels){var o=new DataView(new ArrayBuffer(e/2)),r=new DataView(new ArrayBuffer(e/2));if(16===this.config.sampleBits)for(var s=0;s<e/2;s+=2)o.setInt16(s,t.getInt16(2*s,i),i),r.setInt16(s,t.getInt16(2*s+2,i),i);else for(s=0;s<e/2;s+=2)o.setInt8(s,t.getInt8(2*s)),r.setInt8(s,t.getInt8(2*s+1));n.left=o,n.right=r}else n.left=t;return n},e}(i(5).default);e.default=l},function(t,e,i){"use strict";function n(t,e,i){var n=document.createElement("a");n.href=window.URL.createObjectURL(t),n.download=e+"."+i,n.click()}Object.defineProperty(e,"__esModule",{value:!0}),e.downloadWAV=function(t,e){void 0===e&&(e="recorder"),n(t,e,"wav")},e.downloadPCM=function(t,e){void 0===e&&(e="recorder"),n(t,e,"pcm")},e.download=function(t,e,i){return n(t,e,i)}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=i(4),o=null,r=0,s=0,a=null,l=null,u=null,c=!1,p=0,d=function(){};function h(){return c=!1,a.decodeAudioData(u.slice(0),(function(t){(o=a.createBufferSource()).onended=function(){c||(p=a.currentTime-s+r,d())},o.buffer=t,o.connect(l),l.connect(a.destination),o.start(0,r),s=a.currentTime}),(function(t){n.throwError(t)}))}function f(){o&&(o.stop(),o=null)}var m=function(){function t(){}return t.play=function(t){return a||(a=new(window.AudioContext||window.webkitAudioContext),(l=a.createAnalyser()).fftSize=2048),this.stopPlay(),u=t,p=0,h()},t.pausePlay=function(){f(),r+=a.currentTime-s,c=!0},t.resumePlay=function(){return h()},t.stopPlay=function(){r=0,u=null,f()},t.destroyPlay=function(){this.stopPlay()},t.getAnalyseData=function(){var t=new Uint8Array(l.frequencyBinCount);return l.getByteTimeDomainData(t),t},t.addPlayEnd=function(t){void 0===t&&(t=function(){}),d=t},t.getPlayTime=function(){var t=c?r:a.currentTime-s+r;return p||t},t}();e.default=m},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.throwError=function(t){throw new Error(t)}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=i(0),o=function(){function t(e){void 0===e&&(e={}),this.size=0,this.lBuffer=[],this.rBuffer=[],this.tempPCM=[],this.inputSampleBits=16,this.fileSize=0,this.duration=0,this.needRecord=!0;var i,n=new(window.AudioContext||window.webkitAudioContext);this.inputSampleRate=n.sampleRate,this.setNewOption(e),this.littleEdian=(i=new ArrayBuffer(2),new DataView(i).setInt16(0,256,!0),256===new Int16Array(i)[0]),t.initUserMedia()}return t.prototype.setNewOption=function(t){void 0===t&&(t={}),this.config={sampleBits:~[8,16].indexOf(t.sampleBits)?t.sampleBits:16,sampleRate:~[8e3,11025,16e3,22050,24e3,44100,48e3].indexOf(t.sampleRate)?t.sampleRate:this.inputSampleRate,numChannels:~[1,2].indexOf(t.numChannels)?t.numChannels:1},this.outputSampleRate=this.config.sampleRate,this.oututSampleBits=this.config.sampleBits},t.prototype.startRecord=function(){var t=this;return this.context&&this.destroyRecord(),this.initRecorder(),navigator.mediaDevices.getUserMedia({audio:!0}).then((function(e){t.audioInput=t.context.createMediaStreamSource(e),t.stream=e})).then((function(){t.audioInput.connect(t.analyser),t.analyser.connect(t.recorder),t.recorder.connect(t.context.destination)}))},t.prototype.pauseRecord=function(){this.needRecord=!1},t.prototype.resumeRecord=function(){this.needRecord=!0},t.prototype.stopRecord=function(){this.audioInput&&this.audioInput.disconnect(),this.source&&this.source.stop(),this.recorder.disconnect(),this.analyser.disconnect(),this.needRecord=!0},t.prototype.destroyRecord=function(){return this.clearRecordStatus(),this.stopStream(),this.closeAudioContext()},t.prototype.getAnalyseData=function(){var t=new Uint8Array(this.analyser.frequencyBinCount);return this.analyser.getByteTimeDomainData(t),t},t.prototype.getData=function(){return this.flat()},t.prototype.clearRecordStatus=function(){this.lBuffer.length=0,this.rBuffer.length=0,this.size=0,this.fileSize=0,this.PCM=null,this.audioInput=null,this.duration=0},t.prototype.flat=function(){var t=null,e=new Float32Array(0);1===this.config.numChannels?t=new Float32Array(this.size):(t=new Float32Array(this.size/2),e=new Float32Array(this.size/2));for(var i=0,n=0;n<this.lBuffer.length;n++)t.set(this.lBuffer[n],i),i+=this.lBuffer[n].length;for(i=0,n=0;n<this.rBuffer.length;n++)e.set(this.rBuffer[n],i),i+=this.rBuffer[n].length;return{left:t,right:e}},t.prototype.initRecorder=function(){var t=this;this.clearRecordStatus(),this.context=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.context.createAnalyser(),this.analyser.fftSize=2048;var e=this.context.createScriptProcessor||this.context.createJavaScriptNode;this.recorder=e.apply(this.context,[4096,this.config.numChannels,this.config.numChannels]),this.recorder.onaudioprocess=function(e){if(t.needRecord){var i,n=e.inputBuffer.getChannelData(0),o=null;t.lBuffer.push(new Float32Array(n)),t.size+=n.length,2===t.config.numChannels&&(o=e.inputBuffer.getChannelData(1),t.rBuffer.push(new Float32Array(o)),t.size+=o.length),t.fileSize=Math.floor(t.size/Math.max(t.inputSampleRate/t.outputSampleRate,1))*(t.oututSampleBits/8),i=100*Math.max.apply(Math,n),t.duration+=4096/t.inputSampleRate,t.onprocess&&t.onprocess(t.duration),t.onprogress&&t.onprogress({duration:t.duration,fileSize:t.fileSize,vol:i})}}},t.prototype.stopStream=function(){this.stream&&this.stream.getTracks&&(this.stream.getTracks().forEach((function(t){return t.stop()})),this.stream=null)},t.prototype.closeAudioContext=function(){return this.context&&this.context.close&&"closed"!==this.context.state?this.context.close():new Promise((function(t){t()}))},t.initUserMedia=function(){void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(t){var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return e?new Promise((function(i,n){e.call(navigator,t,i,n)})):Promise.reject(new Error("浏览器不支持 getUserMedia !"))})},t.prototype.transformIntoPCM=function(t,e){var i=new Float32Array(t),o=new Float32Array(e),r=n.compress({left:i,right:o},this.inputSampleRate,this.outputSampleRate);return n.encodePCM(r,this.oututSampleBits,this.littleEdian)},t.getPermission=function(){return this.initUserMedia(),navigator.mediaDevices.getUserMedia({audio:!0}).then((function(t){t&&t.getTracks().forEach((function(t){return t.stop()}))}))},t}();e.default=o}]).default}))},5055:function(t,e,i){t.exports=i(1684)}}]);
//# sourceMappingURL=708.e27f7cd6.js.map